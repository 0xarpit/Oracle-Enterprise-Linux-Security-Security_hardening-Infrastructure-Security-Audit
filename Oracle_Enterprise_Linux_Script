#!/bin/sh


#------------------------------------------------------------------------------------------------------------------------------
# OEL_Security_Audit_Checks
#
#------------------------------------------------------------------------------------------------------------------------------
# Expected output: System Checks Completed
#------------------------------------------------------------------------------------------------------------------------------
# GUIDE
#------------------------------------------------------------------------------------------------------------------------------
# HOW TO USE
#
# The script should be executed as root with bash.
# eg:
#==>   bash OEL_HBA.sh
#			or
# Make the file executable with root privileges: 
#
#==>	chmod a+x OEL_HBA 
#
#Run it as below - 
#==>	./OEL_HBA.sh
#
#------------------------------------------------------------------------------------------------------------------------------
# A series of checks are executed
# No modifications are performed
#
# Running this script should produce no result except the phrase
# "System Checks Completed".
# If there is any other output, then one or more warnings have been issued
#
# There will be an archive created once the script completes.
#------------------------------------------------------------------------------------------------------------------------------

echo "As part of APT 2018 - this HBA script will perform certain checks on this system"
echo "No changes will be made to system"
echo ""
echo ""
echo "Initializing script";
echo ""
sleep 1s
sleep 5s
echo ".........."

#------------------------------------------------------------------------------------------------------------------------------
# 1. 5606-1-OEL-04 Missing Operating System Security Patches 
#------------------------------------------------------------------------------------------------------------------------------

echo '---------------------------------------- System Security Patches-----------------------------------------------' >> Auditcheck.txt
rpm -qPa  >> Auditcheck.txt

echo '---------------------------------------- System Fix-----------------------------------------------' >> Auditcheck.txt
rpm -q --changelog php | less >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 2. 5606-1-OEL-05  Unnecessary Packages Installed
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Packages Installed-----------------------------------------------' >> Auditcheck.txt
rpm -qa  >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 3. 5606-1-OEL-03 Sudoers Permissive Rules
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Sudoers Permissive Rules-----------------------------------------------' >> Auditcheck.txt
cat /etc/sudoers  >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 4. 5606-1-OEL-06 SSH Configuration Weaknesses
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------SSH Configuration Weaknesses-----------------------------------------------' >> Auditcheck.txt

cat /etc/ssh/sshd_config  >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 5. 5605-1-OEL-07 Insecure Permissions On Sensitive Files
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------File Permission---------------------------' >> Auditcheck.txt
cat ls -al /etc/profile  >> Auditcheck.txt
cat ls -al /etc/profile.d  >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 6. 5606-1-OEL-02 Insecure Default Umask
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Insecure Default Umask-----------------------------------------------' >> Auditcheck.txt
umask  >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 7. 5606-1-OEL-08 No Host-Based Firewall
#------------------------------------------------------------------------------------------------------------------------------

echo '---------------------------------------- Host-Based Firewall-----------------------------------------------' >> Auditcheck.txt
firewall-cmd --list-all  >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 8. 5606-1-OEL-09 No Anti-Virus Solution Installed
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Logging and Analysis-----------------------------------------------' >> Auditcheck.txt
cat /var/log/  >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 9. 5606-1-OEL-10 No Centralised Logging and Analysis
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------No Centralised Logging and Analysis-----------------------------------------------' >> Auditcheck.txt
systemctl status rsyslog  >> Auditcheck.txt
echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 10. 5606-1-OEL-11 Unowned Files
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Unowned Files-----------------------------------------------' >> Auditcheck.txt
cat find / -mount -type d -perm /o+w -exec ls -l {} \;  >> Auditcheck.txt
echo '----------------------------------------Unowned Files-----------------------------------------------' >> Auditcheck.txt
cat find / -path /proc -prune -o -nouser -o -nogroup  >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#-------------------------------------------------------------------------------------------------------------
# Creating Archive
zip Audit_check Auditcheck.txt &> /dev/null;
sleep 5
#--------------------------------------------------------------------------------------------------------------
# DONE
#--------------------------------------------------------------------------------------------------------------

echo "System Checks Completed"
